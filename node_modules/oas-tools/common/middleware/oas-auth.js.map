{"version":3,"sources":["../../src/middleware/oas-auth.js"],"names":["removeBasePath","reqRoutePath","split","filter","a","i","config","basePath","join","locationFormat","inProperty","dict","path","query","header","cookie","filterParams","methodParameters","pathParameters","res","paramNames","map","param","name","forEach","pathParam","includes","push","oasDoc","OASAuth","req","next","usedPath","pathsDict","route","method","toLowerCase","logger","debug","securityReqs","paths","security","length","secName","secDef","secReq","Object","keys","find","components","securitySchemes","type","scheme","bearerFormat","grantsFile","ac","AccessControl","accessControlMiddleware","AccessControlMiddleware","action","paramLocation","usedParameter","userProperty","resource","parameters","bearerRegex","token","headers","authorization","replace","decoded","jwt","decode","undefined","parameter","in","checkObject","checkOwnerShip","operands","source","key","user","role","middleware","check"],"mappings":"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","sourcesContent":["import AccessControl from \"accesscontrol\";\nimport AccessControlMiddleware from \"accesscontrol-middleware\";\nimport { config } from \"../configurations\";\nimport jwt from \"jsonwebtoken\";\n\nfunction removeBasePath(reqRoutePath) {\n  return reqRoutePath\n    .split(\"\")\n    .filter((a, i) => {\n      return a !== config.basePath[i];\n    })\n    .join(\"\");\n}\n\nfunction locationFormat(inProperty) {\n  var dict = {\n    path: \"params\",\n    query: \"query\",\n    header: \"header\",\n    cookie: \"cookie\",\n  };\n  return dict[inProperty];\n}\n\nfunction filterParams(methodParameters, pathParameters) {\n  var res = methodParameters;\n  var paramNames = methodParameters.map((param) => {\n    return param.name;\n  });\n  pathParameters.forEach((pathParam) => {\n    if (!paramNames.includes(pathParam.name)) {\n      res.push(pathParam);\n    }\n  });\n  return res;\n}\n\nexport default (oasDoc) => {\n  return function OASAuth(req, res, next) {\n    const usedPath = config.pathsDict[removeBasePath(req.route.path)];\n    const method = req.method.toLowerCase();\n    config.logger.debug(\"Checking authorization...\");\n    var securityReqs =\n      oasDoc.paths[usedPath][method].security || oasDoc.security;\n\n    if (securityReqs && securityReqs.length > 0) {\n      var secName;\n      var secDef;\n      securityReqs.forEach((secReq) => {\n        secName = Object.keys(secReq).find((name) => {\n          secDef = oasDoc.components.securitySchemes[name];\n          return (\n            secDef.type === \"http\" &&\n            secDef.scheme === \"bearer\" &&\n            secDef.bearerFormat === \"JWT\"\n          );\n        });\n      });\n      if (secName && config.grantsFile[secName]) {\n        const ac = new AccessControl(config.grantsFile[secName]);\n        const accessControlMiddleware = new AccessControlMiddleware(ac);\n        var action;\n        switch (method) {\n          case \"get\":\n            action = \"read\";\n            break;\n          case \"head\":\n            action = \"read\";\n            break;\n          case \"post\":\n            action = \"create\";\n            break;\n          case \"put\":\n            action = \"update\";\n            break;\n          case \"patch\":\n            action = \"update\";\n            break;\n          case \"delete\":\n            action = \"delete\";\n        }\n        var paramLocation, usedParameter, userProperty;\n        var resource = usedPath;\n        var methodParameters = oasDoc.paths[usedPath][method].parameters || [];\n        var pathParameters = oasDoc.paths[usedPath].parameters || [];\n        var parameters = filterParams(methodParameters, pathParameters);\n        const bearerRegex = /^Bearer\\s/;\n        var token = req.headers.authorization.replace(bearerRegex, \"\");\n        var decoded = jwt.decode(token);\n        if (parameters !== undefined) {\n          parameters.forEach((parameter) => {\n            if (parameter[\"x-acl-binding\"]) {\n              usedParameter = parameter.name;\n              userProperty = parameter[\"x-acl-binding\"];\n              paramLocation = locationFormat(parameter.in);\n            } else if (\n              !usedParameter &&\n              parameter.in === \"path\" &&\n              decoded[parameter.name]\n            ) {\n              usedParameter = parameter.name;\n              userProperty = parameter.name;\n              paramLocation = \"params\";\n            }\n          });\n        }\n        var checkObject = {\n          resource: resource,\n          action: action,\n          checkOwnerShip: false,\n        };\n        if (usedParameter) {\n          checkObject.checkOwnerShip = true;\n          checkObject.operands = [\n            {\n              source: \"user\",\n              key: userProperty,\n            },\n            {\n              source: paramLocation,\n              key: usedParameter,\n            },\n          ];\n        }\n        if (!req.user) {\n          req.user = {};\n        }\n        req.user.role = decoded.role || \"anonymous\";\n        req.user[userProperty] = decoded[userProperty] || \"\";\n        var middleware = accessControlMiddleware.check(checkObject);\n        middleware(req, res, next);\n      } else {\n        config.logger.debug(\"No security definition including JWT was found\");\n        return next();\n      }\n    } else {\n      config.logger.debug(\"No security requirements found for this request\");\n      return next();\n    }\n  };\n};\n"],"file":"oas-auth.js"}