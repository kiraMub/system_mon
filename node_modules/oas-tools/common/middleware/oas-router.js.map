{"version":3,"sources":["../../src/middleware/oas-router.js"],"names":["cloneDeep","pkg","validator","ZSchema","ignoreUnresolvableReferences","ignoreUnknownFormats","config","breakOnFirstError","getExpectedResponse","responses","code","resp","undefined","Math","floor","default","stripUndefinedKeys","data","maxDepth","Buffer","Object","getOwnPropertyNames","forEach","property","checkResponse","req","res","oldSend","oasDoc","method","requestedSpecPath","content","statusCode","explicitType","msg","logger","debug","JSON","stringify","responseCodeSection","paths","get","header","MIMEtype","newErr","message","push","strict","error","apply","warn","hasOwnProperty","resultType","acceptTypes","headers","accept","split","map","type","trim","acceptType","mimeAccept","keys","contentType","firstMatch","secondMatch","mimeContent","subtype","length","status","essence","validSchema","schema","utils","fixNullable","err","validate","parse","getLastErrors","substr","existsController","locationOfControllers","controllerName","require","path","join","info","getOpId","generateName","operationId","toString","toUpperCase","controllers","OASRouter","next","locals","toLowerCase","opID","controller","send","arguments"],"mappings":"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","sourcesContent":["/*!\nOAS-tools module 0.0.0, built on: 2017-03-30\nCopyright (C) 2017 Ignacio Peluaga Lozada (ISA Group)\nhttps://github.com/ignpelloz\nhttps://github.com/isa-group/project-oas-tools\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.*/\nimport * as utils from \"../lib/utils\";\nimport MIMEtype from \"whatwg-mimetype\";\nimport ZSchema from \"z-schema\";\nimport { config } from \"../configurations\";\nimport path from \"path\";\nimport pkg from \"lodash-compat\";\n\nconst { cloneDeep } = pkg;\nconst validator = new ZSchema({\n  ignoreUnresolvableReferences: true,\n  ignoreUnknownFormats: config.ignoreUnknownFormats,\n  breakOnFirstError: false,\n});\n\nfunction getExpectedResponse(responses, code) {\n  // Exact match wins over range definitions (1XX, 2XX, 3XX, 4XX, 5XX)\n  var resp = responses[code];\n  if (resp !== undefined) {\n    return resp;\n  }\n  resp = responses[Math.floor(code / 100) + \"XX\"];\n  if (resp !== undefined) {\n    return resp;\n  }\n  return responses.default;\n}\n\n/**\n * When an object carries keys whose values are \"undefined\" they fail the z-schema validation even though\n * when those objects are serialized to JSON those keys are never serialized which would effectively make\n * it pass the schema validation.\n * This method strips away (recursively) those undefined keys\n * NOTE: This method modifies the input!\n * @param data\n * @param maxDepth limits the recursion to avoid stack overflow when object references itself\n */\nfunction stripUndefinedKeys(data, maxDepth = 1024) {\n  if (\n    typeof data !== \"object\" ||\n    data === null ||\n    maxDepth <= 0 ||\n    data instanceof Buffer\n  ) {\n    return data;\n  }\n  Object.getOwnPropertyNames(data).forEach((property) => {\n    if (typeof data[property] === \"object\") {\n      stripUndefinedKeys(data[property], maxDepth - 1);\n    } else if (data[property] === undefined) {\n      delete data[property];\n    }\n  });\n  return data;\n}\n\n/**\n * Checks if the data sent as a response for the previous request matches the indicated in the specification file in the responses section for that request.\n * This function is used in the interception of the response sent by the controller to the client that made the request.\n * @param {object} req - req object of the request.\n * @param {object} res - res object of the request.\n * @param {object} oldSend - res object previous to interception.\n * @param {object} oasDoc - Specification file.\n * @param {object} method - Method requested by the client.\n * @param {object} requestedSpecPath - Requested path, as shown in the specification file: /resource/{parameter}\n * @param {object} content - Data sent from controller to client.\n */\nfunction checkResponse(\n  req,\n  res,\n  oldSend,\n  oasDoc,\n  method,\n  requestedSpecPath,\n  content\n) {\n  var code = res.statusCode;\n  var explicitType;\n  var msg = [];\n  var data = stripUndefinedKeys(content[0]);\n  config.logger.debug(\"Processing at checkResponse:\");\n  config.logger.debug(\"  -code: \" + code);\n  config.logger.debug(\"  -oasDoc: \" + JSON.stringify(oasDoc));\n  config.logger.debug(\"  -method: \" + method);\n  config.logger.debug(\"  -requestedSpecPath: \" + requestedSpecPath);\n  config.logger.debug(\"  -data: \" + JSON.stringify(data));\n  var responseCodeSection = getExpectedResponse(\n    oasDoc.paths[requestedSpecPath][method].responses,\n    code\n  ); //Section of the oasDoc file starting at a response code\n  if (res.get(\"content-type\") === undefined) {\n    res.header(\"Content-Type\", \"application/json;charset=utf-8\");\n  } else {\n    explicitType = new MIMEtype(res.get(\"content-type\"));\n  }\n  if (responseCodeSection === undefined) {\n    //if the code is undefined, data wont be checked as a status code is needed to retrieve 'schema' from the oasDoc file\n    var newErr = {\n      message: \"Wrong response code: \" + code,\n    };\n    msg.push(newErr);\n    if (config.strict === true) {\n      config.logger.error(JSON.stringify(msg));\n      content[0] = JSON.stringify(msg);\n      oldSend.apply(res, content);\n    } else {\n      config.logger.warn(JSON.stringify(msg));\n      oldSend.apply(res, content);\n    }\n  } else if (responseCodeSection.hasOwnProperty(\"content\")) {\n    var resultType;\n    var acceptTypes = [];\n    if (req.headers.accept) {\n      acceptTypes = req.headers.accept.split(\",\").map((type) => {\n        return type.trim();\n      });\n    }\n    acceptTypes.forEach((acceptType) => {\n      var mimeAccept = new MIMEtype(acceptType);\n      Object.keys(responseCodeSection.content).forEach((contentType) => {\n        if (!resultType) {\n          var firstMatch, secondMatch;\n          var mimeContent = new MIMEtype(contentType);\n\n          if (explicitType) {\n            firstMatch =\n              explicitType.type === mimeContent.type &&\n              (mimeAccept.type === mimeContent.type || mimeAccept.type === \"*\");\n            secondMatch =\n              explicitType.subtype === mimeContent.subtype &&\n              (mimeAccept.subtype === mimeContent.subtype ||\n                mimeAccept.subtype === \"*\");\n          } else {\n            firstMatch =\n              mimeAccept.type === mimeContent.type || mimeAccept.type === \"*\";\n            secondMatch =\n              mimeAccept.subtype === mimeContent.subtype ||\n              mimeAccept.subtype === \"*\";\n          }\n\n          if (firstMatch && secondMatch) {\n            resultType = mimeContent;\n          }\n        }\n      });\n    });\n    if (!resultType && acceptTypes.length === 0) {\n      resultType = new MIMEtype(\"application/json\");\n    } else if (!resultType && acceptTypes.length !== 0) {\n      newErr = {\n        message: \"No acceptable content type found.\",\n      };\n      msg.push(newErr);\n      content[0] = JSON.stringify(msg);\n      config.logger.error(content[0]);\n      res.status(406);\n    } else {\n      res.header(\"Content-Type\", resultType.essence + \";charset=utf-8\");\n    }\n    if (resultType && resultType.essence === \"application/json\") {\n      //if there is no content property for the given response then there is nothing to validate.\n      var validSchema = cloneDeep(\n        responseCodeSection.content[\"application/json\"].schema\n      );\n      utils.fixNullable(validSchema);\n\n      content[0] = JSON.stringify(content[0]);\n      config.logger.debug(\n        \"Schema to use for validation: \" + JSON.stringify(validSchema)\n      );\n      var err = validator.validate(JSON.parse(content[0]), validSchema);\n\n      if (err === false) {\n        newErr = {\n          message: \"Wrong data in the response. \",\n          error: validator.getLastErrors(),\n          content: data,\n        };\n        msg.push(newErr);\n        if (config.strict === true) {\n          content[0] = JSON.stringify(msg);\n          config.logger.error(content[0]);\n          res.status(400);\n          oldSend.apply(res, content);\n        } else {\n          config.logger.warn(\n            JSON.stringify(msg) + JSON.stringify(validator.getLastErrors())\n          );\n          if (\n            content[0].substr(0, 46) ===\n            '{\"message\":\"This is the mockup controller for '\n          ) {\n            config.logger.warn(\n              \"The used controller might not have been implemented\"\n            );\n          }\n          oldSend.apply(res, content);\n        }\n      } else {\n        oldSend.apply(res, content);\n      }\n    } else {\n      oldSend.apply(res, content);\n    }\n  } else {\n    oldSend.apply(res, content);\n  }\n}\n\n/**\n * Checks whether there is a standard controller (resouce+Controlle) in the location where the controllers are located or not.\n * @param {object} locationOfControllers - Location provided by the user where the controllers can be found.\n * @param {object} controllerName - Name of the controller: resource+'Controller'.\n */\nfunction existsController(locationOfControllers, controllerName) {\n  try {\n    require(path.join(locationOfControllers, controllerName));\n    return true;\n  } catch (err) {\n    config.logger.info(\n      \"The controller \" +\n        controllerName +\n        \" doesn't exist at \" +\n        locationOfControllers\n    );\n    return false;\n  }\n}\n\n/**\n * Returns an operationId. The retrieved one from the specification file or an automatically generated one if it was not specified.\n * @param {object} oasDoc - Specification file.\n * @param {object} requestedSpecPath - Requested path as shown in the specification file.\n * @param {object} method - Requested method.\n */\nfunction getOpId(oasDoc, requestedSpecPath, method) {\n  if (oasDoc.paths[requestedSpecPath][method].hasOwnProperty(\"operationId\")) {\n    return utils.generateName(\n      oasDoc.paths[requestedSpecPath][method].operationId.toString(),\n      undefined\n    ); // Use opID specified in the oas doc\n  }\n  return (\n    utils.generateName(requestedSpecPath, \"function\") + method.toUpperCase()\n  );\n}\n\nexport default (controllers) => {\n  return function OASRouter(req, res, next) {\n    var oasDoc = res.locals.oasDoc;\n    var requestedSpecPath = res.locals.requestedSpecPath; //requested path version on the oasDoc file of the requested url\n    var method = req.method.toLowerCase();\n    var controllerName;\n\n    // pgillis 2019 Jun 10\n    // Handle case where the path has an x-swagger-router-controller.\n    //logger.debug(requestedSpecPath+ \" hasProperty \"+  oasDoc.paths[requestedSpecPath].hasOwnProperty('x-swagger-router-controller'));\n\n    if (\n      oasDoc.paths[requestedSpecPath].hasOwnProperty(\n        \"x-swagger-router-controller\"\n      ) &&\n      oasDoc.paths[requestedSpecPath][method].hasOwnProperty(\n        \"x-swagger-router-controller\"\n      ) === false\n    ) {\n      oasDoc.paths[requestedSpecPath][method] =\n        oasDoc.paths[requestedSpecPath][\"x-swagger-router-controller\"];\n    }\n    if (\n      oasDoc.paths[requestedSpecPath].hasOwnProperty(\"x-router-controller\") &&\n      oasDoc.paths[requestedSpecPath][method].hasOwnProperty(\n        \"x-router-controller\"\n      ) === false\n    ) {\n      oasDoc.paths[requestedSpecPath][method] =\n        oasDoc.paths[requestedSpecPath][\"x-router-controller\"];\n    }\n    // end pgillis\n\n    if (\n      oasDoc.paths[requestedSpecPath][method].hasOwnProperty(\n        \"x-swagger-router-controller\"\n      )\n    ) {\n      //oasDoc file has router_property: use the controller specified there\n      controllerName =\n        oasDoc.paths[requestedSpecPath][method][\"x-swagger-router-controller\"];\n    } else if (\n      oasDoc.paths[requestedSpecPath][method].hasOwnProperty(\n        \"x-router-controller\"\n      )\n    ) {\n      //oasDoc file has router_property: use the controller specified there\n      controllerName =\n        oasDoc.paths[requestedSpecPath][method][\"x-router-controller\"];\n    } else if (\n      existsController(\n        controllers,\n        utils.generateName(requestedSpecPath, \"controller\")\n      )\n    ) {\n      //oasDoc file doesn't have router_property: use the standard controller name (autogenerated) if found\n      controllerName = utils.generateName(requestedSpecPath, \"controller\");\n    } else {\n      //oasDoc file doesn't have router_property and standard controller (autogenerated name) doesn't exist: use the default controller\n      controllerName = \"Default\";\n    }\n\n    var opID = getOpId(oasDoc, requestedSpecPath, method);\n\n    var controller = require(path.join(controllers, controllerName));\n\n    var oldSend = res.send;\n    res.send = function send() {\n      //intercept the response from the controller to check and validate it\n      //Avoids res.send being executed twice: https://stackoverflow.com/questions/41489528/why-is-res-send-being-called-twice\n      checkResponse(\n        req,\n        res,\n        oldSend,\n        oasDoc,\n        method,\n        requestedSpecPath,\n        // eslint-disable-next-line prefer-rest-params\n        arguments\n      );\n    };\n    controller[opID].apply(undefined, [req, res, next]); // execute function by name\n  };\n};\n"],"file":"oas-router.js"}