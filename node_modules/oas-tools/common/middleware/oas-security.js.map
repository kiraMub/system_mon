{"version":3,"sources":["../../src/middleware/oas-security.js"],"names":["getValue","req","secDef","secName","secReq","propName","name","propLocation","in","value","type","scheme","headers","authorization","query","toLowerCase","sendSecurityError","err","res","next","code","statusCode","_","each","header","setHeader","removeBasePath","reqRoutePath","split","filter","a","i","config","basePath","join","verifyToken","token","bearerRegex","sendError","sendStatus","test","newToken","replace","jwt","verify","securityFile","key","algorithms","issuer","error","decoded","specDoc","OASSecurity","handlers","operation","pathsDict","route","path","securityReqs","logger","debug","paths","method","security","length","async","mapSeries","callback","map","Object","keys","components","securitySchemes","Error","rolesObjArr","hasOwnProperty","element","rolesArr","handler","bearerFormat","isNull","undefined","ok","errors","allowed","message"],"mappings":"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","sourcesContent":["import * as _ from \"lodash-compat\";\nimport * as async from \"async\";\nimport { config } from \"../configurations\";\nimport jwt from \"jsonwebtoken\";\n\nvar getValue = (req, secDef, secName, secReq) => {\n  var propName = secDef.name;\n  var propLocation = secDef.in;\n  var value;\n\n  if (secDef.type === \"oauth2\") {\n    value = secReq[secName];\n  } else if (secDef.type === \"http\") {\n    if (secDef.scheme === \"bearer\") {\n      value = req.headers.authorization;\n    }\n  } else if (secDef.type === \"apiKey\") {\n    if (propLocation === \"query\") {\n      value = req.query;\n    } else if (propLocation === \"header\") {\n      value = req.headers[propName.toLowerCase()];\n    }\n  }\n\n  return value;\n};\nvar sendSecurityError = (err, res, next) => {\n  // Populate default values if not present\n  if (!err.code) {\n    err.code = \"server_error\";\n  }\n\n  if (!err.statusCode) {\n    err.statusCode = 403;\n  }\n\n  if (err.headers) {\n    _.each(err.headers, (header, name) => {\n      res.setHeader(name, header);\n    });\n  }\n\n  res.statusCode = err.statusCode;\n  next(err);\n};\n\nfunction removeBasePath(reqRoutePath) {\n  return reqRoutePath\n    .split(\"\")\n    .filter((a, i) => {\n      return a !== config.basePath[i];\n    })\n    .join(\"\");\n}\n\nfunction verifyToken(req, secDef, token, secName, next) {\n  const bearerRegex = /^Bearer\\s/;\n\n  function sendError(statusCode) {\n    return req.res.sendStatus(statusCode);\n  }\n\n  if (token && bearerRegex.test(token)) {\n    var newToken = token.replace(bearerRegex, \"\");\n    jwt.verify(\n      newToken,\n      config.securityFile[secName].key,\n      {\n        algorithms: config.securityFile[secName].algorithms || [\"HS256\"],\n        issuer: config.securityFile[secName].issuer,\n      },\n      (error, decoded) => {\n        if (error === null && decoded) {\n          next();\n          return;\n        }\n        next(sendError(403));\n      }\n    );\n  } else {\n    next(sendError(401));\n  }\n}\n\nexport default (specDoc) => {\n  return function OASSecurity(req, res, next) {\n    var handlers = config.securityFile;\n    var operation = config.pathsDict[removeBasePath(req.route.path)];\n    var securityReqs;\n\n    if (operation) {\n      config.logger.debug(\"Checking security...\");\n      securityReqs =\n        specDoc.paths[operation][req.method.toLowerCase()].security ||\n        specDoc.security;\n\n      if (securityReqs && securityReqs.length > 0) {\n        async.mapSeries(\n          securityReqs,\n          (secReq, callback) => {\n            // logical OR - any one can allow\n            var secName;\n\n            async.map(\n              Object.keys(secReq),\n              (name, callback) => {\n                // logical AND - all must allow\n                var secDef = specDoc.components.securitySchemes[name];\n\n                if (!secDef) {\n                  throw new Error('Undefined \"' + name + '\" security scheme');\n                }\n\n                // start #146, extend the secDef with the array of the securityReq\n                var rolesObjArr = [];\n                for (const i in securityReqs) {\n                  if (securityReqs.hasOwnProperty(i)) {\n                    var element = securityReqs[i];\n                    if (element[name]) {\n                      rolesObjArr = element[name];\n                    }\n                  }\n                }\n                secDef.rolesArr = rolesObjArr;\n                // end #146, of new role adding\n\n                var handler = handlers[name];\n\n                secName = name;\n\n                if (!handler || typeof handler !== \"function\") {\n                  if (\n                    secDef.type === \"http\" &&\n                    secDef.scheme === \"bearer\" &&\n                    secDef.bearerFormat === \"JWT\"\n                  ) {\n                    return verifyToken(\n                      req,\n                      secDef,\n                      req.headers.authorization,\n                      name,\n                      callback\n                    );\n                  }\n                  return callback(\n                    new Error(\n                      \"No handler was specified for security scheme \" + name\n                    )\n                  );\n                }\n\n                return handler(\n                  req,\n                  secDef,\n                  getValue(req, secDef, name, secReq),\n                  callback\n                );\n              },\n              (err) => {\n                config.logger.debug(\n                  \"    Security check \" +\n                    secName +\n                    \": \" +\n                    (_.isNull(err) ? \"allowed\" : \"denied\")\n                );\n\n                // swap normal err and result to short-circuit the logical OR\n                if (err) {\n                  return callback(undefined, err);\n                }\n\n                return callback(new Error(\"OK\"));\n              }\n            );\n          },\n          (ok, errors) => {\n            // note swapped results\n            var allowed = !_.isNull(ok) && ok.message === \"OK\";\n\n            config.logger.debug(\"    Request allowed: \" + allowed);\n\n            if (allowed) {\n              return next();\n            }\n\n            return sendSecurityError(errors[0], res, next);\n          }\n        );\n      } else {\n        return next();\n      }\n    } else {\n      return next();\n    }\n  };\n};\n"],"file":"oas-security.js"}