{"version":3,"sources":["../../src/middleware/oas-auth.js"],"names":["AccessControl","AccessControlMiddleware","config","jwt","removeBasePath","reqRoutePath","split","filter","a","i","basePath","join","locationFormat","inProperty","dict","path","query","header","cookie","filterParams","methodParameters","pathParameters","res","paramNames","map","param","name","forEach","pathParam","includes","push","oasDoc","OASAuth","req","next","usedPath","pathsDict","route","method","toLowerCase","logger","debug","securityReqs","paths","security","length","secName","secDef","secReq","Object","keys","find","components","securitySchemes","type","scheme","bearerFormat","grantsFile","ac","accessControlMiddleware","action","paramLocation","usedParameter","userProperty","resource","parameters","bearerRegex","token","headers","authorization","replace","decoded","decode","undefined","parameter","in","checkObject","checkOwnerShip","operands","source","key","user","role","middleware","check"],"mappings":"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","sourcesContent":["import AccessControl from \"accesscontrol\";\nimport AccessControlMiddleware from \"accesscontrol-middleware\";\nimport { config } from \"../configurations\";\nimport jwt from \"jsonwebtoken\";\n\nfunction removeBasePath(reqRoutePath) {\n  return reqRoutePath\n    .split(\"\")\n    .filter((a, i) => {\n      return a !== config.basePath[i];\n    })\n    .join(\"\");\n}\n\nfunction locationFormat(inProperty) {\n  var dict = {\n    path: \"params\",\n    query: \"query\",\n    header: \"header\",\n    cookie: \"cookie\",\n  };\n  return dict[inProperty];\n}\n\nfunction filterParams(methodParameters, pathParameters) {\n  var res = methodParameters;\n  var paramNames = methodParameters.map((param) => {\n    return param.name;\n  });\n  pathParameters.forEach((pathParam) => {\n    if (!paramNames.includes(pathParam.name)) {\n      res.push(pathParam);\n    }\n  });\n  return res;\n}\n\nexport default (oasDoc) => {\n  return function OASAuth(req, res, next) {\n    const usedPath = config.pathsDict[removeBasePath(req.route.path)];\n    const method = req.method.toLowerCase();\n    config.logger.debug(\"Checking authorization...\");\n    var securityReqs =\n      oasDoc.paths[usedPath][method].security || oasDoc.security;\n\n    if (securityReqs && securityReqs.length > 0) {\n      var secName;\n      var secDef;\n      securityReqs.forEach((secReq) => {\n        secName = Object.keys(secReq).find((name) => {\n          secDef = oasDoc.components.securitySchemes[name];\n          return (\n            secDef.type === \"http\" &&\n            secDef.scheme === \"bearer\" &&\n            secDef.bearerFormat === \"JWT\"\n          );\n        });\n      });\n      if (secName && config.grantsFile[secName]) {\n        const ac = new AccessControl(config.grantsFile[secName]);\n        const accessControlMiddleware = new AccessControlMiddleware(ac);\n        var action;\n        switch (method) {\n          case \"get\":\n            action = \"read\";\n            break;\n          case \"head\":\n            action = \"read\";\n            break;\n          case \"post\":\n            action = \"create\";\n            break;\n          case \"put\":\n            action = \"update\";\n            break;\n          case \"patch\":\n            action = \"update\";\n            break;\n          case \"delete\":\n            action = \"delete\";\n        }\n        var paramLocation, usedParameter, userProperty;\n        var resource = usedPath;\n        var methodParameters = oasDoc.paths[usedPath][method].parameters || [];\n        var pathParameters = oasDoc.paths[usedPath].parameters || [];\n        var parameters = filterParams(methodParameters, pathParameters);\n        const bearerRegex = /^Bearer\\s/;\n        var token = req.headers.authorization.replace(bearerRegex, \"\");\n        var decoded = jwt.decode(token);\n        if (parameters !== undefined) {\n          parameters.forEach((parameter) => {\n            if (parameter[\"x-acl-binding\"]) {\n              usedParameter = parameter.name;\n              userProperty = parameter[\"x-acl-binding\"];\n              paramLocation = locationFormat(parameter.in);\n            } else if (\n              !usedParameter &&\n              parameter.in === \"path\" &&\n              decoded[parameter.name]\n            ) {\n              usedParameter = parameter.name;\n              userProperty = parameter.name;\n              paramLocation = \"params\";\n            }\n          });\n        }\n        var checkObject = {\n          resource: resource,\n          action: action,\n          checkOwnerShip: false,\n        };\n        if (usedParameter) {\n          checkObject.checkOwnerShip = true;\n          checkObject.operands = [\n            {\n              source: \"user\",\n              key: userProperty,\n            },\n            {\n              source: paramLocation,\n              key: usedParameter,\n            },\n          ];\n        }\n        if (!req.user) {\n          req.user = {};\n        }\n        req.user.role = decoded.role || \"anonymous\";\n        req.user[userProperty] = decoded[userProperty] || \"\";\n        var middleware = accessControlMiddleware.check(checkObject);\n        middleware(req, res, next);\n      } else {\n        config.logger.debug(\"No security definition including JWT was found\");\n        return next();\n      }\n    } else {\n      config.logger.debug(\"No security requirements found for this request\");\n      return next();\n    }\n  };\n};\n"],"file":"oas-auth.mjs"}